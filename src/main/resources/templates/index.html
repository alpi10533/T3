<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/css/bootstrap.min.css">
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.3.1/dist/leaflet.css" integrity="sha512-Rksm5RenBEKSKFjgI3a41vrjkw4EVPlJ3+OiI65vTjIdo9brlAacEuKOiQ5OFh7cOI1bkDwLqdLw3Zg0cRJAAQ==" crossorigin="" />
    <title>Accueil</title>
</head>
<body>
    <div class="container">
        <h1 class="mt-4 mb-4">Recherche de circuit touristique</h1>
        <div class="row">
            <div class="col-md-3">
                <div class="card h-100 mb-4">
                    <div class="card-body">
                        <form id="searchForm">
                            <div class="form-group">
                                <label for="travelMode">Mode de déplacement :</label>
                                <select id="travelMode" name="travelMode" class="form-control">
                                    <option value="1">Voiture</option>
                                    <option value="2">Marche</option>
                                    <option value="3">Transports</option>
                                    <option value="4">Vélo</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label for="placeType">Type de lieu :</label>
                                <select id="placeType" name="placeType" class="form-control">
                                    <option value="Monument">Monument</option>
                                    <option value="Musée">Musée</option>
                                    <option value="Lieu de culte">Lieu de culte</option>
                                    <option value="Quartier d'intérêt">Quartier d'intérêt</option>
                                    <option value="">Aucune préférence</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label for="budget">Budget (en euro) :</label>
                                <input type="number" id="budget" name="budget" class="form-control">
                            </div>
                            <div class="form-group">
                                <label for="duration">Durée (en jour):</label>
                                <input type="number" id="duration" name="duration" class="form-control">
                            </div>
                            <input type="submit" value="Rechercher" class="btn btn-primary">
                        </form>
                    </div>
                </div>
            </div>
            <div class="col-md-9">
                <div class="card h-100">
                    <div class="card-body">
                        <div id="map" style="height: 500px;"></div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <script src="https://unpkg.com/leaflet@1.3.1/dist/leaflet.js" integrity="sha512-/Nsx9X4HebavoBvEBuyp3I7od5tA0UzAxs+j83KgC8PU0kgB4XiK4Lfe4y4cgBtaRJQEIFCW+oC506aPT2L1zw==" crossorigin=""></script>
    <script>
        let map = null;
        let markers = [];
        let polyline = null;

        function initMap() {
            map = L.map('map').setView([48.852969, 2.349903], 11);
            L.tileLayer('https://{s}.tile.openstreetmap.fr/osmfr/{z}/{x}/{y}.png', {
                attribution: 'données © <a href="//osm.org/copyright">OpenStreetMap</a>/ODbL - rendu <a href="//openstreetmap.fr">OSM France</a>',
                minZoom: 1,
                maxZoom: 20
            }).addTo(map);
        }

        function search() {
            const formData = new FormData(document.getElementById("searchForm"));
            fetch("/search", {
                method: "post",
                body: formData
            })
                .then(response => response.json())
                .then(nodes => {
                    removeMarkers();
                    removePolyline();
                    displayPlaces(nodes);
                    connectPoints(nodes);
                })
                .catch(error => {
                    console.error("An error occurred during form submission:", error);
                });
        }

        function removeMarkers() {
            markers.forEach(marker => {
                map.removeLayer(marker);
            });
            markers = [];
        }

        function removePolyline() {
            if (polyline) {
                map.removeLayer(polyline);
                polyline = null;
            }
        }

        function displayPlaces(nodes) {
            const firstPlace = nodes[0];
            const lastPlace = nodes[nodes.length - 1];
            nodes.forEach(node => {
                const place = node.place;
                const marker = L.marker([place.latitude, place.longitude]).addTo(map);
                marker.bindPopup(place.name);
                if (node === firstPlace) {
                    marker.setIcon(L.icon({ iconUrl: 'https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-green.png' }));
                }
                if (node === lastPlace) {
                    marker.setIcon(L.icon({ iconUrl: 'https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-red.png' }));
                }
                markers.push(marker);
            });
        }

        function connectPoints(nodes) {
            const latLngs = nodes.map(node => [node.place.latitude, node.place.longitude]);
            polyline = L.polyline(latLngs, { color: 'black' }).addTo(map);
        }

        window.onload = function() {
            initMap();
            const searchForm = document.getElementById("searchForm");
            searchForm.addEventListener("submit", function(event) {
                event.preventDefault();
                search();
            });
        };
    </script>

</body>
</html>